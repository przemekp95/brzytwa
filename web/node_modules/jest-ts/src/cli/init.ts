#!/usr/bin/env node
import fs from 'fs-extra';
import path from 'path';
import { green,gray,blue,yellow,cyan,red} from 'color-printf';

// ç”ŸæˆåŸºç¡€æ–‡ä»¶æ¸…å•
const filesToGenerate = [
  {
    path: 'tsconfig.json',
    content: `{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS", // ä¸è½¬è¯‘å™¨è¾“å‡ºæ ¼å¼ä¸€è‡´
    "moduleResolution": "Node",
    "strict": true,
    "esModuleInterop": true, // å…¼å®¹CommonJSå’ŒESæ¨¡å—
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "outDir": "dist",
    "rootDir": "."
  },
  "include": ["src/**/*", "__tests__/**/*"],
  "exclude": ["node_modules"]
}
`
  },
  {
    path: 'src/__test__/math.ts',
    content: `export const add = (a: number, b: number): number => {
  if (typeof a !== 'number' || typeof b !== 'number') {
    throw new TypeError('å‚æ•°å¿…é¡»ä¸ºæ•°å­—');
  }
  return a + b;
};

export const multiply = (a: number, b: number): number => {
  if (typeof a !== 'number' || typeof b !== 'number') {
    throw new TypeError('å‚æ•°å¿…é¡»ä¸ºæ•°å­—');
  }
  return a * b;
};
`
  },
  {
    path: '__tests__/math.test.ts',
    content: `import { add, multiply } from '../src/__test__/math';

describe('src/__test__/math.ts', () => {
  describe('addå‡½æ•°', () => {
    it('è®¡ç®—ä¸¤ä¸ªæ­£æ•´æ•°çš„å’Œ', () => {
      expect(add(2, 3)).toBe(5);
    });
    it('è®¡ç®—è´Ÿæ•°ä¸æ­£æ•°çš„å’Œ', () => {
      expect(add(-1, 5)).toBe(4);
    });
    it('éæ•°å­—å‚æ•°æŠ›å‡ºTypeError', () => {
      expect(() => add(1, '2')).toThrow(TypeError);
    });
  });

  describe('multiplyå‡½æ•°', () => {
    it('è®¡ç®—ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯', () => {
      expect(multiply(4, 5)).toBe(20);
    });
    it('éæ•°å­—å‚æ•°æŠ›å‡ºTypeError', () => {
      expect(() => multiply(2, null)).toThrow(TypeError);
    });
  });
});
`
  }
];

/**
 * ç”Ÿæˆjest.config.jsï¼Œç¡®ä¿è½¬è¯‘å™¨æ­£ç¡®åº”ç”¨
 */
const generateJestConfig = (projectRoot: string) => ({
  path: 'jest.config.js',
  content: `const path = require('path');

/** @type {import('jest').Config} */
module.exports = {
  // ç¡®ä¿æ‰€æœ‰TypeScriptæ–‡ä»¶éƒ½è¢«è½¬è¯‘
  transform: {
    '^.+\\.(ts|tsx)$': path.resolve(
      '${projectRoot}',
      'node_modules/jest-ts/dist/transformer.js'
    )
  },
  // æ˜ç¡®æŒ‡å®šæ–‡ä»¶æ‰©å±•åä¼˜å…ˆçº§
  moduleFileExtensions: ['ts', 'tsx', 'js', 'json', 'node'],
  preset: undefined,
  testEnvironment: 'node',
  testMatch: [
    '**/__tests__/**/*.+(ts|tsx|js)',
    '**/?(*.)+(spec|test).+(ts|tsx|js)'
  ],
  // ä¸å¿½ç•¥ä»»ä½•éœ€è¦è½¬è¯‘çš„æ–‡ä»¶
  transformIgnorePatterns: []
};
`
});

/**
 * å¤„ç†package.jsonï¼Œç¡®ä¿ä¾èµ–å®Œæ•´
 */
const generatePackageJson = async (projectRoot: string) => {
  const pkgPath = path.resolve(projectRoot, 'package.json');
  const requiredDevDeps = {
    'jest-ts': '^1.0.0',
    'jest': '^29.0.0',
    'typescript': '^5.0.0',
    'esbuild': '^0.20.0'
  };

  try {
    let pkgContent: Record<string, any> = {};
    if (await fs.pathExists(pkgPath)) {
      pkgContent = await fs.readJson(pkgPath, { throws: false }) || {};
      pkgContent.scripts = pkgContent.scripts || {};
      pkgContent.devDependencies = pkgContent.devDependencies || {};

      pkgContent.scripts.test = 'jest';
      pkgContent.scripts['test:watch'] = 'jest --watch';

      Object.entries(requiredDevDeps).forEach(([dep, version]) => {
        if (!pkgContent.devDependencies[dep]) {
          pkgContent.devDependencies[dep] = version;
        }
      });

      await fs.writeJson(pkgPath, pkgContent, { spaces: 2 });
    } else {
      pkgContent = {
        name: path.basename(projectRoot),
        version: '1.0.0',
        private: true,
        scripts: { test: 'jest', 'test:watch': 'jest --watch' },
        devDependencies: requiredDevDeps
      };
      await fs.writeJson(pkgPath, pkgContent, { spaces: 2 });
    }
    console.log(green('âœ… å·²é…ç½®package.json'));
  } catch (error) {
    throw new Error(`å¤„ç†package.jsonå¤±è´¥ï¼š${(error as Error).message}`);
  }
};

/**
 * ç”Ÿæˆå•ä¸ªæ–‡ä»¶
 */
const generateSingleFile = async (filePath: string, fileContent: string) => {
  const fullPath = path.resolve(filePath);
  await fs.ensureDir(path.dirname(fullPath));

  if (await fs.pathExists(fullPath)) {
    const overwrite = await promptUserConfirm(`æ–‡ä»¶ ${yellow(filePath)} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ(y/N) `);
    if (!overwrite) {
      console.log(gray(`  â¤ è·³è¿‡ç”Ÿæˆï¼š${filePath}`));
      return;
    }
  }

  await fs.writeFile(fullPath, fileContent, { encoding: 'utf8' });
  console.log(green(`  âœ… ç”Ÿæˆï¼š${filePath}`));
};

/**
 * ç”¨æˆ·ç¡®è®¤æç¤º
 */
const promptUserConfirm = (promptText: string): Promise<boolean> => {
  return new Promise((resolve) => {
    const readline = require('readline').createInterface({
      input: process.stdin,
      output: process.stdout,
      terminal: process.stdout.isTTY
    });

    readline.question(promptText, (answer: string) => {
      readline.close();
      resolve(answer.trim().toLowerCase() === 'y');
    });

    if (!process.stdout.isTTY) {
      readline.close();
      resolve(false);
    }
  });
};

/**
 * ä¸»åˆå§‹åŒ–æµç¨‹
 */
const init = async () => {
  const projectRoot = process.cwd();
  console.log(blue(`\nğŸš€ åˆå§‹åŒ–jest-tsæµ‹è¯•ç¯å¢ƒï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼š${projectRoot}ï¼‰\n`));

  try {
    // æ£€æŸ¥è½¬è¯‘å™¨æ˜¯å¦å­˜åœ¨
    const transformerPath = path.resolve(
      projectRoot,
      'node_modules/jest-ts/dist/transformer.js'
    );
    if (!await fs.pathExists(transformerPath)) {
      throw new Error(`âŒ è½¬è¯‘å™¨ç¼ºå¤±ï¼š${transformerPath}\nè¯·é‡æ–°å®‰è£…jest-ts`);
    }

    // ç”Ÿæˆé…ç½®æ–‡ä»¶
    console.log(gray('1/2ï¼šç”Ÿæˆé…ç½®æ–‡ä»¶å’Œç¤ºä¾‹ä»£ç '));
    const jestConfig = generateJestConfig(projectRoot);
    for (const file of [...filesToGenerate, jestConfig]) {
      await generateSingleFile(file.path, file.content);
    }

    // å¤„ç†package.json
    console.log(gray('\n2/2ï¼šé…ç½®package.json'));
    await generatePackageJson(projectRoot);

    // å®Œæˆæç¤º
    console.log(blue(`\nğŸ‰ åˆå§‹åŒ–å®Œæˆï¼\n`));
    console.log(gray('1. å®‰è£…ä¾èµ–ï¼š'));
    console.log(`   ${cyan('npm install')}\n`);
    console.log(gray('2. è¿è¡Œæµ‹è¯•ï¼š'));
    console.log(`   ${cyan('npm test')}\n`);

  } catch (error) {
    console.error(red(`\nâŒ åˆå§‹åŒ–å¤±è´¥ï¼š${(error as Error).message}`));
    process.exit(1);
  }
};

// å¯åŠ¨åˆå§‹åŒ–
init();
