# jest-ts

A high-performance Jest TypeScript transpilation tool powered by **esbuild**, designed to solve the slow transpilation pain points of traditional tools. It supports type checking, intelligent caching, and offers a **one-click initialization** feature, making it more efficient and simpler to integrate Jest testing into TypeScript projects.


## Core Features
- ‚ö°Ô∏è **Blazing-Fast Transpilation**: Leverages the esbuild engine to achieve 5-10x faster TS/TSX transpilation compared to traditional tools, with millisecond-level response times.
- üîç **On-Demand Type Checking**: Implements type checking via the official TypeScript API, decoupled from transpilation to avoid blocking test execution.
- üì¶ **Intelligent Caching**: Generates hash-based caching based on code content, configuration, and package version to avoid redundant transpilation, doubling secondary test speeds.
- üöÄ **One-Click Initialization**: `npx jest-ts init` automatically generates configuration files, sample code, and scripts‚Äîno manual setup required.
- üéØ **Multi-Scenario Compatibility**: Supports Node.js/browser (jsdom) test environments, is compatible with CommonJS/ES modules, and works with frameworks like React/Vue.


## Installation
Install via npm, yarn, or pnpm (requires `jest` and `typescript` as peers):

```bash
# npm
npm install jest-ts jest typescript --save-dev

# yarn
yarn add jest-ts jest typescript --dev

# pnpm
pnpm add jest-ts jest typescript -D
```

### Dependency Requirements
- **peerDependencies**: `jest ‚â•28.0.0`, `typescript ‚â•5.0.0`
- **Runtime Environment**: Node.js ‚â•16.0.0 (meets esbuild's minimum requirements)


## Quick Start (Recommended: One-Click Initialization)
Automatically generate all base files with `npx jest-ts init`‚Äîno manual configuration needed. Set up your test environment in 3 steps:

### 1. Run the Initialization Command
In your project root directory, execute:
```bash
npx jest-ts init
```

#### Initialization Process
- **Automatically Generates Configuration Files**: 
  - `jest.config.js` (integrates the `jest-ts` preset)
  - `tsconfig.json` (compatible with Jest's module system)
- **Automatically Generates Sample Code**:
  - Business code: `src/__test__/math.ts` (simple math utility functions)
  - Test cases: `__tests__/math.test.ts` (Jest testing syntax examples)
- **Automatically Updates `package.json`**:
  - Adds `test`/`test:watch` scripts (no manual script writing)
  - Generates base dependency declarations if the file doesn‚Äôt exist

#### Interactive Prompt
If target files already exist (e.g., an existing `jest.config.js`), you‚Äôll be prompted to confirm overwriting to avoid accidental data loss:
```
‚ö†Ô∏è  /your-project/jest.config.js already exists. Overwrite? (y/N) 
```


### 2. Install Dependencies
After initialization, install project dependencies (if `package.json` was generated, run directly):
```bash
# npm
npm install

# yarn
yarn install

# pnpm
pnpm install
```


### 3. Run Tests
Execute the test command to verify the environment is working:
```bash
# Run all tests
npm test

# Watch for file changes and re-run tests in real time (recommended for development)
npm run test:watch
```

#### Expected Test Result (Success Example)
```
 PASS  __tests__/math.test.ts
  src/__test__/math.ts
    add
      ‚úì should correctly calculate the sum of two positive integers (2ms)
      ‚úì should correctly calculate the sum of a negative and positive integer
      ‚úì should throw a TypeError when non-numeric arguments are passed
    multiply
      ‚úì should correctly calculate the product of two numbers
      ‚úì should throw a TypeError when non-numeric arguments are passed
  ‚úì subtract should correctly calculate the difference between two numbers (1ms)

Test Suites: 1 passed, 1 total
Tests:       6 passed, 6 total
Time:        0.85s
```


## Manual Configuration (Advanced Scenarios)
If you need custom configuration (instead of using the `init` command), manually create the following files:

### 1. Jest Configuration (`jest.config.js`)
```javascript
/** @type {import('jest').Config} */
module.exports = {
  // Core: Use the jest-ts preset
  preset: "jest-ts/jest-preset",
  // Test environment: Use "node" for Node.js, "jsdom" for browser projects
  testEnvironment: "node",
  // Custom test file matching rules (adjust as needed)
  testMatch: [
    "**/__tests__/**/*.+(ts|tsx|js)",
    "**/?(*.)+(spec|test).+(ts|tsx|js)"
  ]
};
```

### 2. TypeScript Configuration (`tsconfig.json`)
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS", // Compatible with Jest's module system
    "moduleResolution": "Node",
    "strict": true, // Enable strict type checking (recommended)
    "esModuleInterop": true, // Compatibility between CommonJS and ES modules
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true, // Support importing JSON files
    "outDir": "dist", // Output directory for compiled business code (optional)
    "rootDir": "." // Includes both src and __tests__ directories
  },
  "include": ["src/**/*", "__tests__/**/*"], // Covers business code and test files
  "exclude": ["node_modules"]
}
```


## Custom Configuration
Extend `jest-ts` functionality via Jest‚Äôs `globals` configuration. The following options are supported:

| Configuration       | Type      | Default Value                    | Description                                                                 |
|---------------------|-----------|----------------------------------|-----------------------------------------------------------------------------|
| `typeCheck`         | `boolean` | `false`                         | Enables TypeScript type checking (errors block test execution; uses `tsc --noEmit` under the hood). |
| `cacheDirectory`    | `string`  | `./node_modules/.cache/jest-ts` | Directory for storing cache files (delete this directory to force cache refresh). |
| `tsconfigPath`      | `string`  | `./tsconfig.json`               | Path to a custom TypeScript configuration file (e.g., `tsconfig.test.json` for testing). |
| `esbuildOptions`    | `object`  | `{ target: "es2020", loader: {} }` | Transpilation options passed to esbuild (supports all esbuild `TransformOptions`). |

### Custom Configuration Example (React Project)
```javascript
/** @type {import('jest').Config} */
module.exports = {
  preset: "jest-ts/jest-preset",
  testEnvironment: "jsdom", // Browser environment (required for React projects)
  globals: {
    "jest-ts": {
      typeCheck: true, // Enable type checking
      cacheDirectory: "./.cache/jest-ts", // Custom cache directory
      tsconfigPath: "./tsconfig.test.json", // Test-specific TypeScript config
      esbuildOptions: {
        target: "es2022", // Compatible with modern browsers
        loader: {
          ".tsx": "tsx", // Support React TSX syntax
          ".svg": "dataurl", // Handle SVG files (transpile to Data URL)
          ".css": "css" // Handle CSS files (requires `jest-css-modules` or similar)
        },
        define: {
          "process.env.NODE_ENV": '"test"' // Inject test environment variable
        }
      }
    }
  },
  // Module aliases (match settings in tsconfig.json)
  moduleNameMapper: {
    "^@/(.*)$": "<rootDir>/src/$1"
  },
  // Exclude specific node_modules packages from transpilation
  transformIgnorePatterns: ["/node_modules/(?!@mui/).+\\.tsx$"]
};
```


## API Reference (Advanced Usage)
`jest-ts` exposes core transpilation capabilities for integration into custom workflows (independent of the preset).

### 1. `transformTsCode`
Manually transpiles TypeScript code and returns the transpiled JS code and SourceMap (for debugging).

#### Type Definition
```typescript
import type { JestTsOptions } from "jest-ts";

/**
 * Manually transpiles TypeScript code
 * @param filename Path to the file (used to identify file type, e.g., .ts/.tsx)
 * @param code TypeScript source code to transpile
 * @param globals Custom configuration (matches the "jest-ts" option in Jest globals)
 * @returns Transpilation result (JS code + SourceMap)
 */
export function transformTsCode(
  filename: string,
  code: string,
  globals?: { "jest-ts"?: Partial<JestTsOptions> }
): { code: string; map: string };
```

#### Usage Example
```typescript
import { transformTsCode } from "jest-ts";

// TypeScript code to transpile
const tsCode = `
  export interface User {
    id: number;
    name: string;
  }
  export const formatUser = (user: User): string => \`\${user.id}-\${user.name}\`;
`;

// Execute transpilation
const { code: jsCode, map } = transformTsCode("user.ts", tsCode, {
  "jest-ts": { typeCheck: true }
});

console.log(jsCode);
// Output (type definitions removed, function logic preserved):
// export const formatUser = (user) => `${user.id}-${user.name}`;
```

### 2. `transformer`
A Jest transformer object that can be directly used in Jest‚Äôs `transform` configuration (replaces the preset for highly custom scenarios).

#### Usage Example
```javascript
/** @type {import('jest').Config} */
module.exports = {
  // Use the transformer directly (instead of the preset)
  transform: {
    "^.+\\.(ts|tsx)$": "jest-ts/dist/transformer.js"
  },
  globals: {
    "jest-ts": {
      typeCheck: true,
      tsconfigPath: "./tsconfig.test.json"
    }
  },
  moduleFileExtensions: ["ts", "tsx", "js"]
};
```


## Frequently Asked Questions (FAQ)
### Q1: Test file throws "Cannot use import statement outside a module"
**Cause**: Jest failed to transpile ES module syntax via `jest-ts`, or there‚Äôs a module system incompatibility.  
**Solution**:
1. Ensure the `preset` in `jest.config.js` is set to `"jest-ts/jest-preset"` (not a local path).
2. Verify `module` in `tsconfig.json` is set to `CommonJS` (Jest‚Äôs default supported format).
3. Run `npm ls jest-ts` to confirm the package is installed correctly (no version conflicts).

### Q2: Type errors are not detected even with `typeCheck: true`
**Cause**: The TypeScript configuration does not include test files, or `tsconfigPath` points to the wrong file.  
**Solution**:
1. Ensure `include` in `tsconfig.json` covers the test directory:
   ```json
   { "include": ["src/**/*", "__tests__/**/*"] }
   ```
2. If using a test-specific config (e.g., `tsconfig.test.json`), confirm `tsconfigPath` is set correctly.

### Q3: Cache is not refreshed, and test results remain unchanged after code modifications
**Cause**: Caching is based on code content and configuration hashes‚Äîold cache is reused if no changes are detected.  
**Solution**:
1. Manually delete the cache directory (default: `./node_modules/.cache/jest-ts`).
2. `jest-ts` automatically refreshes the cache based on the package version when the version is updated.

### Q4: Running `npx jest-ts init` throws "command not found"
**Cause**: `jest-ts` is not installed as a project dependency, or the npm version is outdated.  
**Solution**:
1. First install the dependency: `npm install jest-ts --save-dev`.
2. Then run initialization: `npx jest-ts init`.


## License
MIT