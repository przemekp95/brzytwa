# jest-ts

åŸºäº **esbuild** çš„é«˜æ€§èƒ½ Jest TypeScript è½¬è¯‘å·¥å…·ï¼Œè§£å†³ä¼ ç»Ÿ `ts-jest` è½¬è¯‘æ…¢çš„ç—›ç‚¹ï¼Œæ”¯æŒç±»å‹æ£€æŸ¥ã€æ™ºèƒ½ç¼“å­˜ï¼Œå¹¶æä¾› **ä¸€é”®åˆå§‹åŒ–** åŠŸèƒ½ï¼Œè®© TypeScript é¡¹ç›®æ¥å…¥ Jest æµ‹è¯•æ›´é«˜æ•ˆã€æ›´ç®€å•ã€‚


## æ ¸å¿ƒç‰¹æ€§
- âš¡ï¸ **æé€Ÿè½¬è¯‘**ï¼šä¾æ‰˜ esbuild å¼•æ“ï¼ŒTS/TSX è½¬è¯‘é€Ÿåº¦æ¯” `ts-jest` å¿« 5-10 å€ï¼Œæ¯«ç§’çº§å“åº”
- ğŸ” **æŒ‰éœ€ç±»å‹æ£€æŸ¥**ï¼šåŸºäºå®˜æ–¹ TypeScript API å®ç°ç±»å‹æ£€æŸ¥ï¼Œä¸è½¬è¯‘è§£è€¦ï¼Œä¸é˜»å¡æµ‹è¯•æ‰§è¡Œ
- ğŸ“¦ **æ™ºèƒ½ç¼“å­˜**ï¼šæ ¹æ®ä»£ç å†…å®¹ã€é…ç½®ã€åŒ…ç‰ˆæœ¬ç”Ÿæˆå“ˆå¸Œç¼“å­˜ï¼Œé¿å…é‡å¤è½¬è¯‘ï¼ŒäºŒæ¬¡æµ‹è¯•é€Ÿåº¦ç¿»å€
- ğŸš€ **ä¸€é”®åˆå§‹åŒ–**ï¼š`npx jest-ts init` è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ã€ç¤ºä¾‹ä»£ç å’Œè„šæœ¬ï¼Œé›¶æ‰‹åŠ¨æ“ä½œ
- ğŸ¯ **å¤šåœºæ™¯é€‚é…**ï¼šæ”¯æŒ Node.js/æµè§ˆå™¨ï¼ˆjsdomï¼‰æµ‹è¯•ç¯å¢ƒï¼Œå…¼å®¹ CommonJS/ES æ¨¡å—ï¼Œé€‚é… React/Vue ç­‰æ¡†æ¶


## å®‰è£…
é€šè¿‡ npmã€yarn æˆ– pnpm å®‰è£…ï¼ˆéœ€æ­é… `jest` å’Œ `typescript` ä½¿ç”¨ï¼‰ï¼š

```bash
# npm
npm install jest-ts jest typescript --save-dev

# yarn
yarn add jest-ts jest typescript --dev

# pnpm
pnpm add jest-ts jest typescript -D
```

### ä¾èµ–è¦æ±‚
- **peerDependencies**ï¼š`jest â‰¥28.0.0`ã€`typescript â‰¥5.0.0`
- **è¿è¡Œç¯å¢ƒ**ï¼šNode.js â‰¥16.0.0ï¼ˆé€‚é… esbuild æœ€ä½è¦æ±‚ï¼‰


## å¿«é€Ÿå¼€å§‹ï¼ˆæ¨èï¼šä¸€é”®åˆå§‹åŒ–ï¼‰
é€šè¿‡ `npx jest-ts init` è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰åŸºç¡€æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œ3 æ­¥å®Œæˆæµ‹è¯•ç¯å¢ƒæ­å»ºï¼š

### 1. æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤
åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š
```bash
npx jest-ts init
```

#### åˆå§‹åŒ–æµç¨‹è¯´æ˜
- è‡ªåŠ¨ç”Ÿæˆ **é…ç½®æ–‡ä»¶**ï¼š`jest.config.js`ï¼ˆé›†æˆ `jest-ts` é¢„è®¾ï¼‰ã€`tsconfig.json`ï¼ˆé€‚é… Jest æ¨¡å—ç³»ç»Ÿï¼‰
- è‡ªåŠ¨ç”Ÿæˆ **ç¤ºä¾‹ä»£ç **ï¼š
  - ä¸šåŠ¡ä»£ç ï¼š`src/__test__/math.ts`ï¼ˆç®€å•æ•°å­¦å·¥å…·å‡½æ•°ï¼‰
  - æµ‹è¯•ç”¨ä¾‹ï¼š`__tests__/math.test.ts`ï¼ˆJest æµ‹è¯•è¯­æ³•ç¤ºä¾‹ï¼‰
- è‡ªåŠ¨æ›´æ–° **package.json**ï¼š
  - æ–°å¢ `test`/`test:watch` è„šæœ¬ï¼ˆæ— éœ€æ‰‹åŠ¨å†™è„šæœ¬ï¼‰
  - è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç”ŸæˆåŸºç¡€ä¾èµ–å£°æ˜

#### äº¤äº’æç¤º
è‹¥ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼ˆå¦‚ç°æœ‰ `jest.config.js`ï¼‰ï¼Œä¼šæç¤ºæ˜¯å¦è¦†ç›–ï¼Œé¿å…è¯¯åˆ ç”¨æˆ·æ•°æ®ï¼š
```
âš ï¸  /your-project/jest.config.js å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ(y/N) 
```


### 2. å®‰è£…ä¾èµ–
åˆå§‹åŒ–å®Œæˆåï¼Œå®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆè‹¥ `package.json` å·²ç”Ÿæˆï¼Œç›´æ¥æ‰§è¡Œï¼‰ï¼š
```bash
# npm
npm install

# yarn
yarn install

# pnpm
pnpm install
```


### 3. è¿è¡Œæµ‹è¯•
æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼ŒéªŒè¯ç¯å¢ƒæ˜¯å¦æ­£å¸¸ï¼š
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# ç›‘å¬æ–‡ä»¶å˜æ›´ï¼Œå®æ—¶é‡è·‘æµ‹è¯•ï¼ˆå¼€å‘æ—¶æ¨èï¼‰
npm run test:watch
```

#### é¢„æœŸæµ‹è¯•ç»“æœï¼ˆæˆåŠŸç¤ºä¾‹ï¼‰
```
 PASS  __tests__/math.test.ts
  src/__test__/math.ts
    add
      âœ“ åº”è¯¥æ­£ç¡®è®¡ç®—ä¸¤ä¸ªæ­£æ•´æ•°çš„å’Œ (2ms)
      âœ“ åº”è¯¥æ­£ç¡®è®¡ç®—è´Ÿæ•°ä¸æ­£æ•°çš„å’Œ
      âœ“ ä¼ å…¥éæ•°å­—å‚æ•°æ—¶åº”è¯¥æŠ›å‡º TypeError
    multiply
      âœ“ åº”è¯¥æ­£ç¡®è®¡ç®—ä¸¤ä¸ªæ•°çš„ä¹˜ç§¯
      âœ“ ä¼ å…¥éæ•°å­—å‚æ•°æ—¶åº”è¯¥æŠ›å‡º TypeError
  âœ“ subtract åº”è¯¥æ­£ç¡®è®¡ç®—ä¸¤ä¸ªæ•°çš„å·® (1ms)

Test Suites: 1 passed, 1 total
Tests:       6 passed, 6 total
Time:        0.85s
```


## æ‰‹åŠ¨é…ç½®ï¼ˆè¿›é˜¶åœºæ™¯ï¼‰
è‹¥éœ€è‡ªå®šä¹‰é…ç½®ï¼ˆä¸ä½¿ç”¨ `init` å‘½ä»¤ï¼‰ï¼Œå¯æ‰‹åŠ¨åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š

### 1. Jest é…ç½®ï¼ˆjest.config.jsï¼‰
```javascript
/** @type {import('jest').Config} */
module.exports = {
  // æ ¸å¿ƒï¼šä½¿ç”¨ jest-ts é¢„è®¾
  preset: "jest-ts/jest-preset",
  // æµ‹è¯•ç¯å¢ƒï¼šNode.js ç”¨ "node"ï¼Œæµè§ˆå™¨é¡¹ç›®ç”¨ "jsdom"
  testEnvironment: "node",
  // æµ‹è¯•æ–‡ä»¶åŒ¹é…è§„åˆ™ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
  testMatch: [
    "**/__tests__/**/*.+(ts|tsx|js)",
    "**/?(*.)+(spec|test).+(ts|tsx|js)"
  ]
};
```

### 2. TypeScript é…ç½®ï¼ˆtsconfig.jsonï¼‰
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS", // é€‚é… Jest æ¨¡å—ç³»ç»Ÿ
    "moduleResolution": "Node",
    "strict": true, // å¼€å¯ä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼ˆæ¨èï¼‰
    "esModuleInterop": true, // å…¼å®¹ CommonJS/ES æ¨¡å—
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true, // æ”¯æŒå¯¼å…¥ JSON æ–‡ä»¶
    "outDir": "dist", // ä¸šåŠ¡ä»£ç ç¼–è¯‘ç›®å½•ï¼ˆå¯é€‰ï¼‰
    "rootDir": "." // åŒ…å« src å’Œ __tests__ ç›®å½•
  },
  "include": ["src/**/*", "__tests__/**/*"], // è¦†ç›–ä¸šåŠ¡ä»£ç å’Œæµ‹è¯•æ–‡ä»¶
  "exclude": ["node_modules"]
}
```


## è‡ªå®šä¹‰é…ç½®
é€šè¿‡ Jest çš„ `globals` é…ç½®é¡¹æ‰©å±• `jest-ts` åŠŸèƒ½ï¼Œæ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

| é…ç½®é¡¹          | ç±»å‹      | é»˜è®¤å€¼                          | è¯´æ˜                                                                 |
|-----------------|-----------|---------------------------------|----------------------------------------------------------------------|
| `typeCheck`     | `boolean` | `false`                         | å¼€å¯ TypeScript ç±»å‹æ£€æŸ¥ï¼ˆé”™è¯¯ä¼šé˜»æ–­æµ‹è¯•æ‰§è¡Œï¼Œåº•å±‚æ‰§è¡Œ `tsc --noEmit`ï¼‰ |
| `cacheDirectory`| `string`  | `./node_modules/.cache/jest-ts` | ç¼“å­˜æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆåˆ é™¤è¯¥ç›®å½•å¯å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼‰                          |
| `tsconfigPath`  | `string`  | `./tsconfig.json`               | è‡ªå®šä¹‰ TypeScript é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æµ‹è¯•ä¸“ç”¨ `tsconfig.test.json`ï¼‰    |
| `esbuildOptions`| `object`  | `{ target: "es2020", loader: {} }` | ä¼ é€’ç»™ esbuild çš„è½¬è¯‘é€‰é¡¹ï¼ˆæ”¯æŒæ‰€æœ‰ esbuild `TransformOptions`ï¼‰     |

### è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹ï¼ˆReact é¡¹ç›®ï¼‰
```javascript
/** @type {import('jest').Config} */
module.exports = {
  preset: "jest-ts/jest-preset",
  testEnvironment: "jsdom", // æµè§ˆå™¨ç¯å¢ƒï¼ˆReact é¡¹ç›®éœ€ç”¨ jsdomï¼‰
  globals: {
    "jest-ts": {
      typeCheck: true, // å¼€å¯ç±»å‹æ£€æŸ¥
      cacheDirectory: "./.cache/jest-ts", // è‡ªå®šä¹‰ç¼“å­˜ç›®å½•
      tsconfigPath: "./tsconfig.test.json", // æµ‹è¯•ä¸“ç”¨ TS é…ç½®
      esbuildOptions: {
        target: "es2022", // é€‚é…ç°ä»£æµè§ˆå™¨
        loader: {
          ".tsx": "tsx", // æ”¯æŒ React TSX è¯­æ³•
          ".svg": "dataurl", // å¤„ç† SVG æ–‡ä»¶ï¼ˆè½¬è¯‘ä¸º Data URLï¼‰
          ".css": "css" // å¤„ç† CSS æ–‡ä»¶ï¼ˆéœ€é…åˆ `jest-css-modules`ï¼‰
        },
        define: {
          "process.env.NODE_ENV": '"test"' // æ³¨å…¥æµ‹è¯•ç¯å¢ƒå˜é‡
        }
      }
    }
  },
  // æ¨¡å—åˆ«åï¼ˆä¸ tsconfig.json ä¿æŒä¸€è‡´ï¼‰
  moduleNameMapper: {
    "^@/(.*)$": "<rootDir>/src/$1"
  },
  // å¿½ç•¥ node_modules ä¸­çš„ç‰¹å®šåŒ…è½¬è¯‘
  transformIgnorePatterns: ["/node_modules/(?!@mui/).+\\.tsx$"]
};
```


## API å‚è€ƒï¼ˆè¿›é˜¶ä½¿ç”¨ï¼‰
`jest-ts` å¯¼å‡ºæ ¸å¿ƒè½¬è¯‘èƒ½åŠ›ï¼Œæ”¯æŒè„±ç¦»é¢„è®¾ç›´æ¥é›†æˆåˆ°è‡ªå®šä¹‰æµç¨‹ä¸­ã€‚

### 1. `transformTsCode`
æ‰‹åŠ¨è½¬è¯‘ TypeScript ä»£ç ï¼Œè¿”å›è½¬è¯‘åçš„ JS ä»£ç å’Œ SourceMapï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚

#### ç±»å‹å®šä¹‰
```typescript
import type { JestTsOptions } from "jest-ts";

/**
 * æ‰‹åŠ¨è½¬è¯‘ TypeScript ä»£ç 
 * @param filename æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºè¯†åˆ«æ–‡ä»¶ç±»å‹ï¼Œå¦‚ .ts/.tsxï¼‰
 * @param code å¾…è½¬è¯‘çš„ TypeScript æºä»£ç 
 * @param globals è‡ªå®šä¹‰é…ç½®ï¼ˆåŒ Jest globals ä¸­çš„ "jest-ts" é€‰é¡¹ï¼‰
 * @returns è½¬è¯‘ç»“æœï¼ˆJS ä»£ç  + SourceMapï¼‰
 */
export function transformTsCode(
  filename: string,
  code: string,
  globals?: { "jest-ts"?: Partial<JestTsOptions> }
): { code: string; map: string };
```

#### ä½¿ç”¨ç¤ºä¾‹
```typescript
import { transformTsCode } from "jest-ts";

// å¾…è½¬è¯‘çš„ TS ä»£ç 
const tsCode = `
  export interface User {
    id: number;
    name: string;
  }
  export const formatUser = (user: User): string => \`\${user.id}-\${user.name}\`;
`;

// æ‰§è¡Œè½¬è¯‘
const { code: jsCode, map } = transformTsCode("user.ts", tsCode, {
  "jest-ts": { typeCheck: true }
});

console.log(jsCode);
// è¾“å‡ºï¼ˆç±»å‹å®šä¹‰è¢«ç§»é™¤ï¼Œä¿ç•™å‡½æ•°é€»è¾‘ï¼‰ï¼š
// export const formatUser = (user) => `${user.id}-${user.name}`;
```

### 2. `transformer`
Jest è½¬æ¢å™¨å¯¹è±¡ï¼Œå¯ç›´æ¥ç”¨äº Jest çš„ `transform` é…ç½®ï¼ˆæ›¿ä»£é¢„è®¾ï¼Œé€‚åˆé«˜åº¦è‡ªå®šä¹‰åœºæ™¯ï¼‰ã€‚

#### ä½¿ç”¨ç¤ºä¾‹
```javascript
/** @type {import('jest').Config} */
module.exports = {
  // ä¸ä½¿ç”¨é¢„è®¾ï¼Œç›´æ¥æŒ‡å®šè½¬æ¢å™¨
  transform: {
    "^.+\\.(ts|tsx)$": "jest-ts/dist/transformer.js"
  },
  globals: {
    "jest-ts": {
      typeCheck: true,
      tsconfigPath: "./tsconfig.test.json"
    }
  },
  moduleFileExtensions: ["ts", "tsx", "js"]
};
```


## å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰
### Q1: æµ‹è¯•æ–‡ä»¶æŠ¥é”™ â€œCannot use import statement outside a moduleâ€
**åŸå› **ï¼šJest æœªé€šè¿‡ `jest-ts` è½¬è¯‘ ES æ¨¡å—è¯­æ³•ï¼Œæˆ–æ¨¡å—ç³»ç»Ÿé…ç½®ä¸å…¼å®¹ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ `jest.config.js` ä¸­ `preset` ä¸º `"jest-ts/jest-preset"`ï¼ˆéæœ¬åœ°è·¯å¾„ï¼‰ã€‚
2. æ£€æŸ¥ `tsconfig.json` ä¸­ `module` é…ç½®ä¸º `CommonJS`ï¼ˆJest é»˜è®¤æ”¯æŒï¼‰ã€‚
3. æ‰§è¡Œ `npm ls jest-ts` ç¡®è®¤åŒ…å·²æ­£ç¡®å®‰è£…ï¼ˆæ— ç‰ˆæœ¬å†²çªï¼‰ã€‚

### Q2: å¼€å¯ `typeCheck: true` åï¼Œç±»å‹é”™è¯¯æœªè¢«æ£€æµ‹åˆ°
**åŸå› **ï¼šTS é…ç½®æœªåŒ…å«æµ‹è¯•æ–‡ä»¶ï¼Œæˆ– `tsconfigPath` æŒ‡å‘é”™è¯¯ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ `tsconfig.json` çš„ `include` åŒ…å«æµ‹è¯•ç›®å½•ï¼š
   ```json
   { "include": ["src/**/*", "__tests__/**/*"] }
   ```
2. è‹¥ä½¿ç”¨æµ‹è¯•ä¸“ç”¨é…ç½®ï¼ˆå¦‚ `tsconfig.test.json`ï¼‰ï¼Œç¡®è®¤ `tsconfigPath` è·¯å¾„æ­£ç¡®ã€‚

### Q3: ç¼“å­˜æœªåˆ·æ–°ï¼Œä¿®æ”¹ä»£ç åæµ‹è¯•ç»“æœä¸å˜
**åŸå› **ï¼šç¼“å­˜åŸºäºä»£ç å†…å®¹å’Œé…ç½®å“ˆå¸Œï¼Œæœªæ£€æµ‹åˆ°å˜æ›´æ—¶å¤ç”¨æ—§ç¼“å­˜ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ‰‹åŠ¨åˆ é™¤ç¼“å­˜ç›®å½•ï¼ˆé»˜è®¤ `./node_modules/.cache/jest-ts`ï¼‰ã€‚
2. ç‰ˆæœ¬æ›´æ–°æ—¶ï¼Œ`jest-ts` ä¼šè‡ªåŠ¨æ ¹æ®åŒ…ç‰ˆæœ¬åˆ·æ–°ç¼“å­˜ã€‚

### Q4: æ‰§è¡Œ `npx jest-ts init` æç¤º â€œcommand not foundâ€
**åŸå› **ï¼š`jest-ts` æœªå®‰è£…åˆ°é¡¹ç›®ä¾èµ–ï¼Œæˆ– npm ç‰ˆæœ¬è¿‡ä½ã€‚  
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆå®‰è£…ä¾èµ–ï¼š`npm install jest-ts --save-dev`ã€‚
2. å†æ‰§è¡Œåˆå§‹åŒ–ï¼š`npx jest-ts init`ã€‚

## è®¸å¯è¯
MIT